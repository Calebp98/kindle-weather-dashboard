<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #fff;
            color: #000;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Optimize for e-ink displays */
            -webkit-font-smoothing: none;
            font-smooth: never;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .location {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #000;
        }

        .current-temp {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
            color: #000;
        }

        .condition {
            font-size: 20px;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #000;
        }

        .details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
            color: #333;
        }

        .detail-value {
            color: #000;
            font-weight: bold;
        }

        .clothing-advice {
            border-top: 2px solid #000;
            padding-top: 20px;
            margin-top: 20px;
        }

        .clothing-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #000;
        }

        .clothing-bullets {
            font-size: 13px;
            line-height: 1.3;
            color: #000;
            background: #f9f9f9;
            padding: 15px;
            border: 1px solid #ccc;
        }

        .clothing-bullets ul {
            margin: 0;
            padding-left: 20px;
        }

        .clothing-bullets li {
            margin-bottom: 8px;
        }

        /* Temperature graph styles */
        .temp-graph {
            border-top: 2px solid #000;
            padding-top: 20px;
            margin-top: 20px;
        }

        .graph-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #000;
        }

        .graph-container {
            height: 150px;
            position: relative;
            margin: 20px 0;
            background: #fff;
            padding: 20px 10px 30px 40px; /* top, right, bottom, left */
        }

        .graph-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .graph-point {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #000;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }

        .graph-label-x {
            position: absolute;
            font-size: 11px;
            color: #333;
            transform: translateX(-50%);
            bottom: -5px;
        }

        .graph-label-y {
            position: absolute;
            font-size: 11px;
            color: #333;
            transform: translateY(-50%);
            left: -35px;
            font-weight: bold;
        }

        .loading {
            font-size: 18px;
            opacity: 0.8;
            color: #333;
        }

        .error {
            color: #000;
            background-color: #f0f0f0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
        }

        .last-updated {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            opacity: 0.6;
            color: #333;
        }

        .next-update {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            opacity: 0.6;
            color: #333;
        }

        /* Optimize for Kindle's e-ink display */
        @media (max-width: 480px) {
            .current-temp {
                font-size: 60px;
            }
            
            .location {
                font-size: 20px;
            }
        }

        /* High contrast for e-ink */
        .container {
            background: #fff;
            border: 2px solid #000;
            padding: 20px;
            border-radius: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="weather-content">
            <div class="loading">Loading weather...</div>
        </div>
    </div>
    
    <div class="last-updated" id="last-updated"></div>
    <div class="next-update" id="next-update"></div>

    <script>
        // Try to load config, fallback to demo mode if not available
        let config = null;
        try {
            // This will only work in development, not in production
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onerror = () => {
                console.log('Config file not found, using demo mode');
                config = { apiKey: null };
            };
            document.head.appendChild(script);
        } catch (e) {
            console.log('Config file not found, using demo mode');
            config = { apiKey: null };
        }

        class WeatherDashboard {
            constructor() {
                // Use API key if available, otherwise use demo mode
                this.apiKey = config && config.apiKey ? config.apiKey : null;
                this.weatherContent = document.getElementById('weather-content');
                this.lastUpdated = document.getElementById('last-updated');
                this.nextUpdate = document.getElementById('next-update');
                this.updateInterval = 15 * 60 * 1000; // 15 minutes for Kindle optimization
                this.init();
            }

            async init() {
                // Default to Cambridge, Milton Road coordinates
                this.lat = 52.2174;
                this.lon = 0.1278;
                this.updateWeather();
                // Refresh every 15 minutes for Kindle battery optimization
                setInterval(() => this.updateWeather(), this.updateInterval);
            }

            async updateWeather() {
                // If no API key, use demo data
                if (!this.apiKey) {
                    this.displayDemo();
                    return;
                }

                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric`);
                    
                    if (!response.ok) {
                        throw new Error('Weather service unavailable');
                    }

                    const data = await response.json();
                    this.displayWeather(data);
                } catch (error) {
                    console.log('API error, falling back to demo data:', error);
                    this.displayDemo();
                }
            }

            displayDemo() {
                // Demo data for when API isn't available
                const demoData = {
                    location: "Cambridge, UK",
                    current: {
                        temp: 16,
                        condition: "Partly Cloudy",
                        humidity: 68,
                        wind: 14,
                        feels_like: 18
                    },
                    forecast: [
                        { day: "Today", condition: "Cloudy", high: 20, low: 12 },
                        { day: "Tomorrow", condition: "Rain", high: 17, low: 10 },
                        { day: "Wed", condition: "Sunny", high: 23, low: 15 },
                        { day: "Thu", condition: "Cloudy", high: 19, low: 13 },
                        { day: "Fri", condition: "Rain", high: 16, low: 9 }
                    ],
                    hourly: [
                        { time: "8AM", temp: 14, condition: "Cloudy", rainChance: 20 },
                        { time: "9AM", temp: 15, condition: "Cloudy", rainChance: 25 },
                        { time: "10AM", temp: 16, condition: "Partly Cloudy", rainChance: 15 },
                        { time: "11AM", temp: 17, condition: "Partly Cloudy", rainChance: 10 },
                        { time: "12PM", temp: 18, condition: "Sunny", rainChance: 5 },
                        { time: "1PM", temp: 19, condition: "Sunny", rainChance: 5 },
                        { time: "2PM", temp: 20, condition: "Sunny", rainChance: 10 },
                        { time: "3PM", temp: 19, condition: "Partly Cloudy", rainChance: 15 },
                        { time: "4PM", temp: 18, condition: "Cloudy", rainChance: 20 },
                        { time: "5PM", temp: 17, condition: "Cloudy", rainChance: 25 },
                        { time: "6PM", temp: 16, condition: "Cloudy", rainChance: 30 },
                        { time: "7PM", temp: 15, condition: "Light Rain", rainChance: 60 },
                        { time: "8PM", temp: 14, condition: "Light Rain", rainChance: 70 },
                        { time: "9PM", temp: 13, condition: "Rain", rainChance: 80 },
                        { time: "10PM", temp: 12, condition: "Rain", rainChance: 85 }
                    ]
                };

                this.renderWeather(demoData);
            }

            displayWeather(data) {
                const weatherData = {
                    location: data.city.name + ", " + data.city.country,
                    current: {
                        temp: Math.round(data.list[0].main.temp),
                        condition: data.list[0].weather[0].description,
                        humidity: data.list[0].main.humidity,
                        wind: Math.round(data.list[0].wind.speed * 3.6), // Convert to km/h
                        feels_like: Math.round(data.list[0].main.feels_like)
                    },
                    forecast: this.processForecast(data.list),
                    hourly: this.processHourlyForecast(data.list)
                };

                this.renderWeather(weatherData);
            }

            processForecast(list) {
                const dailyData = {};
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const dayKey = date.toDateString();
                    
                    if (!dailyData[dayKey]) {
                        dailyData[dayKey] = {
                            day: date.getDate() === new Date().getDate() ? 'Today' : days[date.getDay()],
                            temps: [],
                            conditions: []
                        };
                    }
                    
                    dailyData[dayKey].temps.push(item.main.temp);
                    dailyData[dayKey].conditions.push(item.weather[0].main);
                });

                return Object.values(dailyData).slice(0, 5).map(day => ({
                    day: day.day,
                    condition: this.getMostCommonCondition(day.conditions),
                    high: Math.round(Math.max(...day.temps)),
                    low: Math.round(Math.min(...day.temps))
                }));
            }

            getMostCommonCondition(conditions) {
                const counts = conditions.reduce((acc, condition) => {
                    acc[condition] = (acc[condition] || 0) + 1;
                    return acc;
                }, {});
                
                return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            processHourlyForecast(list) {
                const hourlyData = [];
                const today = new Date();
                const targetHours = [8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
                
                // Get today's hourly data
                const todayData = list.filter(item => {
                    const itemDate = new Date(item.dt * 1000);
                    return itemDate.getDate() === today.getDate() && 
                           itemDate.getMonth() === today.getMonth() &&
                           itemDate.getFullYear() === today.getFullYear();
                });

                targetHours.forEach(hour => {
                    // Find the closest forecast to this hour
                    const hourData = todayData.find(item => {
                        const itemDate = new Date(item.dt * 1000);
                        return itemDate.getHours() === hour;
                    }) || todayData[0]; // Fallback to first available data

                    if (hourData) {
                        const itemDate = new Date(hourData.dt * 1000);
                        const timeString = itemDate.getHours() <= 12 ? 
                            `${itemDate.getHours()}AM` : 
                            `${itemDate.getHours() - 12}PM`;
                        
                        hourlyData.push({
                            time: timeString,
                            temp: Math.round(hourData.main.temp),
                            condition: hourData.weather[0].description,
                            rainChance: this.calculateRainChance(hourData)
                        });
                    }
                });

                return hourlyData;
            }

            calculateRainChance(weatherData) {
                // Calculate rain chance based on weather conditions and humidity
                const condition = weatherData.weather[0].main.toLowerCase();
                const humidity = weatherData.main.humidity;
                
                if (condition.includes('rain') || condition.includes('drizzle')) {
                    return Math.min(95, humidity + 20);
                } else if (condition.includes('snow')) {
                    return Math.min(90, humidity + 15);
                } else if (condition.includes('cloud')) {
                    return Math.min(60, humidity - 20);
                } else {
                    return Math.max(5, humidity - 40);
                }
            }

            generateClothingAdvice(hourlyData) {
                const temps = hourlyData.map(h => h.temp);
                const maxTemp = Math.max(...temps);
                const minTemp = Math.min(...temps);
                const avgTemp = Math.round(temps.reduce((a, b) => a + b, 0) / temps.length);
                
                const rainHours = hourlyData.filter(h => h.rainChance > 50).length;
                const highRainHours = hourlyData.filter(h => h.rainChance > 70).length;
                
                let bullets = [];
                
                // Temperature-based clothing advice
                if (maxTemp >= 25) {
                    bullets.push("Light clothing like t-shirts and shorts would be comfortable");
                } else if (maxTemp >= 20) {
                    bullets.push("A light jacket or sweater should be sufficient");
                } else if (maxTemp >= 15) {
                    bullets.push("Consider a medium-weight jacket or coat");
                } else if (maxTemp >= 10) {
                    bullets.push("You'll want a warm coat or jacket");
                } else {
                    bullets.push("Bundle up with a heavy coat, scarf, and gloves");
                }
                
                // Rain advice
                if (highRainHours > 5) {
                    bullets.push("Heavy rain expected - bring waterproof jacket and umbrella");
                } else if (rainHours > 3) {
                    bullets.push("Good chance of rain - bring light rain jacket or umbrella");
                } else if (rainHours > 0) {
                    bullets.push("Slight chance of rain - carry small umbrella just in case");
                } else {
                    bullets.push("No rain expected - no need for rain gear");
                }
                
                // Additional advice
                bullets.push(`Temperature range: ${minTemp}° to ${maxTemp}° (avg: ${avgTemp}°)`);
                bullets.push("Check hourly forecast below for specific timing");
                
                return bullets;
            }

            createTemperatureGraph(hourlyData) {
                if (!hourlyData || hourlyData.length < 2) return '';
                
                const temps = hourlyData.map(h => h.temp);
                const minTemp = Math.min(...temps);
                const maxTemp = Math.max(...temps);
                const tempRange = maxTemp - minTemp;
                
                const graphWidth = 100; // percentage
                const graphHeight = 100; // percentage
                
                let svgPath = '';
                let points = '';
                let xLabels = '';
                let yLabels = '';
                
                // Generate Y-axis labels (Temperature)
                const numYLabels = 3;
                for (let i = 0; i <= numYLabels; i++) {
                    const temp = Math.round(minTemp + (tempRange / numYLabels) * i);
                    const y = graphHeight - ((temp - minTemp) / tempRange) * graphHeight;
                    if (tempRange === 0) {
                         yLabels += `<div class="graph-label-y" style="top: 50%;">${temp}°</div>`;
                         break;
                    }
                    yLabels += `<div class="graph-label-y" style="top: ${y}%;">${temp}°</div>`;
                }
                
                hourlyData.forEach((hour, index) => {
                    const x = (index / (hourlyData.length - 1)) * graphWidth;
                    const y = tempRange > 0 ? 
                        graphHeight - ((hour.temp - minTemp) / tempRange) * graphHeight : 
                        graphHeight / 2;
                    
                    if (index === 0) {
                        svgPath += `M ${x} ${y}`;
                    } else {
                        svgPath += ` L ${x} ${y}`;
                    }
                    
                    points += `<div class="graph-point" style="left: ${x}%; top: ${y}%;"></div>`;
                    
                    // Add X-axis labels (Time) - every 4th hour
                    if (index % 4 === 0 || index === hourlyData.length - 1) {
                         xLabels += `<div class="graph-label-x" style="left: ${x}%;">${hour.time}</div>`;
                    }
                });
                
                return `
                    <div class="graph-container">
                        <svg class="graph-line" viewBox="0 0 100 100" preserveAspectRatio="none">
                            <path d="${svgPath}" stroke="#000" stroke-width="2" fill="none"/>
                        </svg>
                        ${points}
                        ${xLabels}
                        ${yLabels}
                    </div>
                `;
            }

            renderWeather(data) {
                const clothingAdvice = this.generateClothingAdvice(data.hourly || []);
                const tempGraph = this.createTemperatureGraph(data.hourly || []);
                
                this.weatherContent.innerHTML = `
                    <div class="location">${data.location}</div>
                    <div class="current-temp">${data.current.temp}°</div>
                    <div class="condition">${data.current.condition}</div>
                    
                    <div class="details">
                        <div class="detail-item">
                            <div class="detail-label">FEELS LIKE</div>
                            <div class="detail-value">${data.current.feels_like}°</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HUMIDITY</div>
                            <div class="detail-value">${data.current.humidity}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">WIND</div>
                            <div class="detail-value">${data.current.wind} km/h</div>
                        </div>
                    </div>

                    <div class="clothing-advice">
                        <div class="clothing-title">WHAT TO WEAR</div>
                        <div class="clothing-bullets">
                            <ul>
                                ${clothingAdvice.map(advice => `<li>${advice}</li>`).join('')}
                            </ul>
                        </div>
                    </div>

                    <div class="temp-graph">
                        <div class="graph-title">TEMPERATURE TREND (8AM-10PM)</div>
                        ${tempGraph}
                    </div>
                `;

                const now = new Date();
                const nextUpdateTime = new Date(now.getTime() + this.updateInterval);
                
                this.lastUpdated.textContent = `Updated: ${now.toLocaleTimeString()}`;
                this.nextUpdate.textContent = `Next: ${nextUpdateTime.toLocaleTimeString()}`;
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new WeatherDashboard();
        });

        // Optimized for Kindle - minimal background activity
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause updates when not visible to save battery
                console.log('Page hidden, pausing updates');
            } else {
                console.log('Page visible, resuming updates');
            }
        });
    </script>
</body>
</html>