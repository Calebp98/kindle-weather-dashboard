<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background-color: #fff;
            color: #000;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Optimize for e-ink displays */
            -webkit-font-smoothing: none;
            font-smooth: never;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            text-align: center;
        }

        .location {
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: bold;
            color: #000;
        }

        .current-temp {
            font-size: 72px;
            font-weight: bold;
            margin: 20px 0;
            color: #000;
        }

        .condition {
            font-size: 20px;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #000;
        }

        .details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .detail-item {
            text-align: center;
        }

        .detail-label {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
            color: #333;
        }

        .detail-value {
            color: #000;
            font-weight: bold;
        }

        .forecast {
            border-top: 2px solid #000;
            padding-top: 20px;
        }

        .forecast-title {
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
            color: #000;
        }

        .forecast-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ccc;
        }

        .forecast-item:last-child {
            border-bottom: none;
        }

        .day {
            font-weight: bold;
            width: 80px;
            text-align: left;
            color: #000;
        }

        .forecast-condition {
            flex: 1;
            text-align: center;
            font-size: 14px;
            color: #000;
        }

        .temps {
            text-align: right;
            width: 80px;
        }

        .high {
            font-weight: bold;
            color: #000;
        }

        .low {
            opacity: 0.7;
            color: #333;
        }

        .loading {
            font-size: 18px;
            opacity: 0.8;
            color: #333;
        }

        .error {
            color: #000;
            background-color: #f0f0f0;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 20px 0;
        }

        .last-updated {
            position: fixed;
            bottom: 10px;
            right: 10px;
            font-size: 10px;
            opacity: 0.6;
            color: #333;
        }

        .next-update {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 10px;
            opacity: 0.6;
            color: #333;
        }

        /* Optimize for Kindle's e-ink display */
        @media (max-width: 480px) {
            .current-temp {
                font-size: 60px;
            }
            
            .location {
                font-size: 20px;
            }
        }

        /* High contrast for e-ink */
        .container {
            background: #fff;
            border: 2px solid #000;
            padding: 20px;
            border-radius: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="weather-content">
            <div class="loading">Loading weather...</div>
        </div>
    </div>
    
    <div class="last-updated" id="last-updated"></div>
    <div class="next-update" id="next-update"></div>

    <script>
        // Try to load config, fallback to demo mode if not available
        let config = null;
        try {
            // This will only work in development, not in production
            const script = document.createElement('script');
            script.src = 'config.js';
            script.onerror = () => {
                console.log('Config file not found, using demo mode');
                config = { apiKey: null };
            };
            document.head.appendChild(script);
        } catch (e) {
            console.log('Config file not found, using demo mode');
            config = { apiKey: null };
        }

        class WeatherDashboard {
            constructor() {
                // Use API key if available, otherwise use demo mode
                this.apiKey = config && config.apiKey ? config.apiKey : null;
                this.weatherContent = document.getElementById('weather-content');
                this.lastUpdated = document.getElementById('last-updated');
                this.nextUpdate = document.getElementById('next-update');
                this.updateInterval = 15 * 60 * 1000; // 15 minutes for Kindle optimization
                this.init();
            }

            async init() {
                // Default to Cambridge, Milton Road coordinates
                this.lat = 52.2174;
                this.lon = 0.1278;
                this.updateWeather();
                // Refresh every 15 minutes for Kindle battery optimization
                setInterval(() => this.updateWeather(), this.updateInterval);
            }

            async updateWeather() {
                // If no API key, use demo data
                if (!this.apiKey) {
                    this.displayDemo();
                    return;
                }

                try {
                    const response = await fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${this.lat}&lon=${this.lon}&appid=${this.apiKey}&units=metric`);
                    
                    if (!response.ok) {
                        throw new Error('Weather service unavailable');
                    }

                    const data = await response.json();
                    this.displayWeather(data);
                } catch (error) {
                    console.log('API error, falling back to demo data:', error);
                    this.displayDemo();
                }
            }

            displayDemo() {
                // Demo data for when API isn't available
                const demoData = {
                    location: "Cambridge, UK",
                    current: {
                        temp: 16,
                        condition: "Partly Cloudy",
                        humidity: 68,
                        wind: 14,
                        feels_like: 18
                    },
                    forecast: [
                        { day: "Today", condition: "Cloudy", high: 20, low: 12 },
                        { day: "Tomorrow", condition: "Rain", high: 17, low: 10 },
                        { day: "Wed", condition: "Sunny", high: 23, low: 15 },
                        { day: "Thu", condition: "Cloudy", high: 19, low: 13 },
                        { day: "Fri", condition: "Rain", high: 16, low: 9 }
                    ]
                };

                this.renderWeather(demoData);
            }

            displayWeather(data) {
                const weatherData = {
                    location: data.city.name + ", " + data.city.country,
                    current: {
                        temp: Math.round(data.list[0].main.temp),
                        condition: data.list[0].weather[0].description,
                        humidity: data.list[0].main.humidity,
                        wind: Math.round(data.list[0].wind.speed * 3.6), // Convert to km/h
                        feels_like: Math.round(data.list[0].main.feels_like)
                    },
                    forecast: this.processForecast(data.list)
                };

                this.renderWeather(weatherData);
            }

            processForecast(list) {
                const dailyData = {};
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                list.forEach(item => {
                    const date = new Date(item.dt * 1000);
                    const dayKey = date.toDateString();
                    
                    if (!dailyData[dayKey]) {
                        dailyData[dayKey] = {
                            day: date.getDate() === new Date().getDate() ? 'Today' : days[date.getDay()],
                            temps: [],
                            conditions: []
                        };
                    }
                    
                    dailyData[dayKey].temps.push(item.main.temp);
                    dailyData[dayKey].conditions.push(item.weather[0].main);
                });

                return Object.values(dailyData).slice(0, 5).map(day => ({
                    day: day.day,
                    condition: this.getMostCommonCondition(day.conditions),
                    high: Math.round(Math.max(...day.temps)),
                    low: Math.round(Math.min(...day.temps))
                }));
            }

            getMostCommonCondition(conditions) {
                const counts = conditions.reduce((acc, condition) => {
                    acc[condition] = (acc[condition] || 0) + 1;
                    return acc;
                }, {});
                
                return Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
            }

            renderWeather(data) {
                this.weatherContent.innerHTML = `
                    <div class="location">${data.location}</div>
                    <div class="current-temp">${data.current.temp}°</div>
                    <div class="condition">${data.current.condition}</div>
                    
                    <div class="details">
                        <div class="detail-item">
                            <div class="detail-label">FEELS LIKE</div>
                            <div class="detail-value">${data.current.feels_like}°</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">HUMIDITY</div>
                            <div class="detail-value">${data.current.humidity}%</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">WIND</div>
                            <div class="detail-value">${data.current.wind} km/h</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">PRESSURE</div>
                            <div class="detail-value">-- hPa</div>
                        </div>
                    </div>

                    <div class="forecast">
                        <div class="forecast-title">5-DAY FORECAST</div>
                        ${data.forecast.map(day => `
                            <div class="forecast-item">
                                <div class="day">${day.day}</div>
                                <div class="forecast-condition">${day.condition}</div>
                                <div class="temps">
                                    <span class="high">${day.high}°</span>
                                    <span class="low">${day.low}°</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                const now = new Date();
                const nextUpdateTime = new Date(now.getTime() + this.updateInterval);
                
                this.lastUpdated.textContent = `Updated: ${now.toLocaleTimeString()}`;
                this.nextUpdate.textContent = `Next: ${nextUpdateTime.toLocaleTimeString()}`;
            }
        }

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            new WeatherDashboard();
        });

        // Optimized for Kindle - minimal background activity
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // Pause updates when not visible to save battery
                console.log('Page hidden, pausing updates');
            } else {
                console.log('Page visible, resuming updates');
            }
        });
    </script>
</body>
</html>